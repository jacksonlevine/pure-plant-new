

---

//TODO IMPORT CONFIG 
import { AddToCart } from "@/functional-components/cart/AddToCart";
import ProductGallery from "@/functional-components/product/ProductGallery";
import ShowTags from "@/functional-components/product/ShowTags";
import Tabs from "@/functional-components/product/Tabs";
import { VariantSelector } from "@/functional-components/product/VariantSelector";
// import SocialShare from "../../functional-components/SocialShare";
import { getListPage } from "../../lib/contentParser.astro";
import { getProduct, getProducts } from "@/lib/shopify";
import Layout from "../../layouts/Layout.astro";

export const prerender = true;

export async function getStaticPaths() {
    // fetch all products
    const { products } = await getProducts({}); // no query needed, gets everythingF

    // map to slugs
    return products.map((product) => ({
        params: { slug: product.handle }, // matches Astro.params.slug
    }));
}



const { slug } = Astro.params;
const product = await getProduct(slug as string);


if (!product) {
  return Astro.redirect("/404");
}

const {
  id,
  title,
  description,
  descriptionHtml,
  priceRange,
  compareAtPriceRange,
  images,
  options,
  variants,
  tags,
} = product;
//
// const relatedProducts = await getProductRecommendations(id);
const defaultVariantId = variants.length > 0 ? variants[0].id : undefined;

const currencySymbol = '$';

//JSON LD stuff

const site = Astro.site ?? new URL("https://jacksonlevine.github.io");
const basePath = import.meta.env.BASE_URL ?? "/";
const siteBase = new URL(basePath, site).toString().replace(/\/$/, "");
const productUrl = `${siteBase}/products/${slug}`;

const productImages = images
    .map((image) => image?.url)
    .filter((url): url is string => Boolean(url));

const offerList = variants.map((variant) => ({
    "@type": "Offer",
    price: variant.price.amount,
    priceCurrency: variant.price.currencyCode,
    availability: variant.availableForSale
        ? "https://schema.org/InStock"
        : "https://schema.org/OutOfStock",
    url: productUrl,
    itemCondition: "https://schema.org/NewCondition",
    sku: variant.id,
}));

const offersData =
    offerList.length > 1
        ? {
            "@type": "AggregateOffer",
            priceCurrency: priceRange?.minVariantPrice?.currencyCode,
            lowPrice: priceRange?.minVariantPrice?.amount,
            highPrice: priceRange?.maxVariantPrice?.amount,
            offerCount: offerList.length,
            offers: offerList,
        }
        : offerList[0];

const relatedProductHandles: Record<string, string> = {
    Serophan: "serophan",
    Neurozine: "neurozine",
    "PurePlant D3": "pureplantd3",
};

const productStructuredData = [
    {
        "@type": "Product",
        "@id": `${productUrl}#product`,
        name: title,
        description,
        brand: {
            "@type": "Brand",
            name: "Pure Plant",
        },
        ...(productImages.length ? { image: productImages } : {}),
        ...(offersData ? { offers: offersData } : {}),
        sku: variants?.[0]?.id,
        url: productUrl,
        isRelatedTo: Object.entries(relatedProductHandles)
            .filter(([name]) => name !== title)
            .map(([name, handle]) => ({
                "@type": "Product",
                name,
                brand: {
                    "@type": "Brand",
                    name: "Pure Plant",
                },
                url: `${siteBase}/products/${handle}`,
            })),
    },
    {
        "@type": "BreadcrumbList",
        "@id": `${productUrl}#breadcrumb`,
        itemListElement: [
            {
                "@type": "ListItem",
                position: 1,
                name: "Products",
                item: `${siteBase}/products`,
            },
            {
                "@type": "ListItem",
                position: 2,
                name: title,
                item: productUrl,
            },
        ],
    },
];


---

<Layout
        title={`${title} | Pure Plant`}
        description={description}
        structuredData={productStructuredData}
>
    <div class="h-[12rem] lg:h-[6rem]"></div>
  <section class="md:section-sm">
    <div class="container">
      <div class="row justify-center">
        {/* right side contents */}
        <div class="col-10 md:col-8 lg:col-6">
          <ProductGallery client:only="react" images={images} />
        </div>

        {/* left side contents */}
        <div class="col-10 md:col-8 lg:col-5 md:ml-7 py-6 lg:py-0">
          <h1 class="text-3xl md:h2 mb-2 md:mb-6">{title}</h1>

          <div class="flex gap-2 items-center">
            <h4 class="text-text-light dark:text-darkmode-text-light max-md:h2">
              {currencySymbol}
              {priceRange?.minVariantPrice.amount}{" "}
              {priceRange?.minVariantPrice?.currencyCode}
            </h4>
            {
              parseFloat(compareAtPriceRange?.maxVariantPrice.amount) > 0 ? (
                <s class="text-text-light max-md:h3 dark:text-darkmode-text-light">
                  {currencySymbol}{" "}
                  {compareAtPriceRange?.maxVariantPrice?.amount}{" "}
                  {compareAtPriceRange?.maxVariantPrice?.currencyCode}
                </s>
              ) : (
                ""
              )
            }
          </div>

          <div class="my-10 md:my-10 space-y-6 md:space-y-10">
            <div>
              {
                options && (
                  <VariantSelector
                    client:only="react"
                    options={options}
                    variants={variants}
                    images={images}
                  />
                )
              }
            </div>
          </div>

          <div class="flex gap-4 mt-8 md:mt-10 mb-6">
            <AddToCart
              client:only="react"
              variants={product?.variants}
              availableForSale={product?.availableForSale}
              stylesClass={"btn max-md:btn-sm btn-primary"}
              handle={null}
              defaultVariantId={defaultVariantId}
            />
          </div>

          <!--<div class="mb-8 md:mb-10">-->
          <!--  <p-->
          <!--    class="p-2 max-md:text-sm rounded-md bg-light dark:bg-darkmode-light inline"-->
          <!--  >-->
          <!--    {estimated_delivery}-->
          <!--  </p>-->
          <!--</div>-->
          
          <!--<div class="flex flex-wrap items-center gap-3">-->
          <!--  <h5 class="max-md:text-base">Payment:</h5>-->
          <!--  {-->
          <!--    payment_methods?.map(-->
          <!--      (payment: { name: string; image_url: string }) => (-->
          <!--        <img-->
          <!--          src={payment.image_url}-->
          <!--          alt={payment.name}-->
          <!--          width={44}-->
          <!--          height={32}-->
          <!--        />-->
          <!--      )-->
          <!--    )-->
          <!--  }-->
          <!--</div>-->

          <hr class="my-6 border border-border dark:border-border/40" />

          <div class="flex gap-3 items-center mb-6">
            <h5 class="max-md:text-base">Share:</h5>
            <!--<SocialShare-->
            <!--  socialName={title}-->
            <!--  className="social-icons"-->
            <!--  pathname={Astro.url.pathname}-->
            <!--  client:only="react"-->
            <!--/>-->
          </div>

          {
            tags.length > 0 && (
              <div class="flex flex-wrap gap-3 items-center">
                <h5 class="max-md:text-base">Tags:</h5>
                <ShowTags client:only="react" tags={tags} />
              </div>
            )
          }
        </div>
      </div>
    </div>
  </section>

  {/* Description of a product  */}
  {
    description && (
      <section>
        <div class="container">
          <div class="row">
            <div class="col-10 lg:col-11 mx-auto mt-12">
              <Tabs client:only="react" descriptionHtml={descriptionHtml} />
            </div>
          </div>
        </div>
      </section>
    )
  }

  {/* Recommended Products section  */}
  <!--<section class="section">-->
  <!--  <div class="container">-->
  <!--    {-->
  <!--      relatedProducts?.length > 0 && (-->
  <!--        <>-->
  <!--          <div class="text-center mb-6 md:mb-14">-->
  <!--            <h2 class="mb-2">Related Products</h2>-->
  <!--          </div>-->
  <!--          <FeaturedProducts products={relatedProducts.slice(0, 4)} />-->
  <!--        </>-->
  <!--      )-->
  <!--    }-->
  <!--  </div>-->
  <!--</section>-->
</Layout>
